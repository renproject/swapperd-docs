# Swaps

Executing an atomic swap requires two parties to participate in an interactive swapping process. This interactive swapping process will either result in both parties exchanging their tokens, or both parties keeping their tokens.

Before beginning an atomic swap, swapperd assumes that the two parties:

1. Agree that one party begins the atomic swap.  
2. Exchange their Swapperd addresses for the relevant tokens.

Before responding to an atomic swap, swapperd assumes that the two parties:

1. Exchange the `timeLock` and `secretHash` generated by the party that begins the atomic swap.

Swapperd handles all other interactions. Swapperd is built to be fault-tolerant and in the event of an unexpected shutdown, or unexpected errors, it retries actions as needed. All actions are idempotent and cannot result in an accidental double execution.

<aside class="notice">
Swapperd cannot execute the interactive swapping process when the host machine is shut down, or offline. Keeping the host machine shutdown, or offline, for more than 24 hours could result in the loss of funds!
</aside>

## Supported Tokens

- Bitcoin: "bitcoin", "btc", "xbt"
- Ether: "ethereum", "eth", "ether"
- WrappedBitcoin: "wrappedbtc", "wbtc", "wrappedbitcoin"
- Ren: "ren", "republictoken", "republic token"
- TrueUSD: "tusd", "trueusd", "true-usd"
- DigixGoldToken: "digix-gold-token", "dgx", "dgt"
- ZeroEx: "zerox", "zrx", "0x"
- OmiseGo: "omisego", "omg", "omise-go"
- CircleUSD: "usdc", "usd-coin", "usdcoin"
- MakerDAI: "dai", "maker-dai", "makerdai"
- GeminiUSD: "gusd", "gemini-dollar", "geminidollar"
- Paxos: "pax", "paxosstandardtoken", "paxos-standard-token"

Name | Type | Usage
---------- | ------- | ---------------- 
sendToken | TokenName | The name of the token you want to send
receiveToken | TokenName | The name of the token you want to receive
sendAmount | string | The amount of token you want to send (decimal string)
receiveAmount | string | The amount of token you want to receive (decimal string)
shouldInitiateFirst | bool | Should the swapper initiate first
timeLock | int64 | Timelock of the initiating atomic swap (required when shouldInitiateFirst is false).
secretHash | string | Base64 encoding of the secret hash (required when shouldInitiateFirst is false).
sendTo | string | counter-party's `sendToken` address (required when doing an immediate swap).
receiveFrom | string | counter-party's `receiveToken` address (required when doing an immediate swap).
sendFee | string (optional) | `sendToken` transaction fee
receiveFee | string (optional) | `receiveToken` transaction fee
brokerFee | int64 (optional) | broker/matching fee in bips
brokerSendTokenAddr | string (optional) | broker's `sendToken` address
brokerReceiveTokenAddr | string (optional) | broker's `receiveToken` address
minimumReceiveAmount | string (optional, default: "0") | used when the delay is true, to check the updated swap details
delay | bool (optional, default: false) | set it to true if it is a delayed swap
delayCallbackURL | string (optional) | url to which swapperd can post the partial swap information to get it filled.
delayInfo | JSON (optional) | information required by your server behind `delayCallbackURL` to identify the user and the swap.

## `POST` Starting swaps

> Beginning an atomic swap by initiating first:

```shell
curl -i      \
     -X POST \
     -d '{
          "sendToken":"BTC",
          "receiveToken":"ETH",
          "sendAmount":"20000",
          "receiveAmount":"20000000000000000",
          "sendTo":"n2RcTmQu2PoRcfHn7uyfQ2jWVcmuHDQLnh",
          "receiveFrom":"0x780c6d20b6C59F4b5F3658A66E1e8ef22d61725D",
          "shouldInitiateFirst":true
        }' \
     http://username:password@localhost:17927/swaps
```

> The response body is structured like this:

```json
{
    "id": "c7t5VHbJdx2M0PtRS6G3lN2nrRH1fX0arUoZYkFBlvI=",
    "swap": {
      "sendToken": "ETH",
      "receiveToken": "BTC",
      "sendAmount": "20000000000000000",
      "receiveAmount": "20000",
      "sendTo": "0x5Ea5F67cC958023F2da2ea92231d358F2a3BbA47",
      "receiveFrom": "mzKgUBHX7xSkKiNrdnxTe6fJKAcvFri2Tc",
      "timeLock": 1548669277,
      "secretHash": "3YyU0uyS2TKWdAkVQpQWwTXRXcEkpjpya8atI2x+OTE=",
      "shouldInitiateFirst": false,
  },
    "signature": "qruvrzo2hpyCp76wdcmpo+E+5fZ42n2MNyA4sOjSCzgr8rYh4tLZ0vpKrGDqYptOXzYpakC+NKgPO51hFM7L4AE="
}
```

The beginning party sends an HTTP request to his Swapperd using the agreed addresses.

Swapperd validates the request and generates the responding swap object. The beginning party can send this response to the responding party. The responding party can check KYC (if they require it), by using the signature. Then they could start the responding swap with the given swap object.

The beginning party can check the status of their swap using the <code>id</code> returned by the swapperd.

**HTTP Endpoint:** `POST /swaps`

|         | SwapperD | SwapperD Desktop |
| ------- | -------- | ---------------- |
| Mainnet | http://localhost:7927/swaps | http://localhost:7928/swaps |
| Testnet | http://localhost:17927/swaps | http://localhost:7928/swaps?network=testnet |

<aside class="success">
Basic Authentication is required for these SwapperD HTTP endpoints. 
</aside>


## `POST` Responding to swaps

> Respond to an atomic swap by initiating second:

```shell
curl -i      \
     -X POST \
     -d '{
        "sendToken": "ETH",
        "receiveToken": "BTC",
        "sendAmount": "20000000000000000",
        "receiveAmount": "20000",
        "sendTo": "0x5Ea5F67cC958023F2da2ea92231d358F2a3BbA47",
        "receiveFrom": "mzKgUBHX7xSkKiNrdnxTe6fJKAcvFri2Tc",
        "timeLock": 1548669277,
        "secretHash": "3YyU0uyS2TKWdAkVQpQWwTXRXcEkpjpya8atI2x+OTE=",
        "shouldInitiateFirst": false,
    }' \
    http://username:password@localhost:17927/swaps
```

> The response body is structured like this:

```json
{
  "id": "S1Jn5MTLBqD8M2lm6vYjt1n2qy7XlW7sjHyIY3eInNA=",
}
```

After receiving the response from the beginning party (and checking the KYC information if required), the responding party sends the swap object they received to their swapperd.

**HTTP Endpoint:** `POST /swaps`

|         | SwapperD | SwapperD Desktop |
| ------- | -------- | ---------------- |
| Mainnet | http://localhost:7927/swaps | http://localhost:7928/swaps |
| Testnet | http://localhost:17927/swaps | http://localhost:7928/swaps?network=testnet |

<aside class="success">
Basic Authentication is required for these SwapperD HTTP endpoints. 
</aside>


## `POST` Starting delayed swaps

In some cases, we do not know both sides of an atomic swap, before committing to an atomic swap. An example use-case would be an exchange using swapperd, and an
exchange would want to make sure that if it finds an order match the users execute the swap. To solve this problem, we introduced a feature called delayed swaps.

A user starts an atomic swap, and the swap request has a `delayCallbackUrl` which
the swapperd keeps pinging with the relevant information. So once the counter-party is found the server pointed to by the `delayCallbackUrl` returns the swap blobs of both traders. The swappers of the traders check the new swap details, and they check the following: 

- The price is equal to or better than the initial price.
- The updated send value is less than or equal to the initial value.
- The updated receive value is greater than or equal to the initial minimum receive value.
- The updated token pair is same as the initial token pair.

If all the checks pass, the atomic swap goes through, if they do not the swap fails.

```shell
curl -i      \
     -X POST \
     -d '{
        "sendToken": "ETH",
        "receiveToken": "BTC",
        "sendAmount": "200000000000000000",
        "receiveAmount": "2000000",
        "minimumReceiveAmount": "1000000",

        "delay": true,
        "delayInfo": {
          "usecaseSpecificKey": "usecaseSpecificValue",
        },
        "delayCallbackUrl": "your_swapperd_callback_url"
    }' \
    http://username:password@localhost:17927/swaps
```

> The swapperd pings `your_swapperd_callback_url` with the following request:

```json
  {
      "sendToken": "ETH",
      "receiveToken": "BTC",
      "sendAmount": "200000000000000000",
      "receiveAmount": "2000000",
      "minimumReceiveAmount": "1000000",

      "delay": true,
      "delayInfo": {
        "usecaseSpecificKey": "usecaseSpecificValue",
      },
      "delayCallbackUrl": "your_swapperd_callback_url"
  }
```

Swapperd expects `delayCallbackUrl` to respond with one of the following responses. 

Status Code | Meaning | Response
---------- | ------- | --------------------
200 | StatusOK -- Success | A filled executable swap json object.
204 | StatusNoContent -- Please try again after some time. | Nothing.
410 | StatusGone -- The swap is cancelled, stop requesting. | Nothing.

**HTTP Endpoint:** `POST /swaps`

|         | SwapperD | SwapperD Desktop |
| ------- | -------- | ---------------- |
| Mainnet | http://localhost:7927/swaps | http://localhost:7928/swaps |
| Testnet | http://localhost:17927/swaps | http://localhost:7928/swaps?network=testnet |

<aside class="success">
Basic Authentication is required for these SwapperD HTTP endpoints. 
</aside>


## `GET` Status of existing swaps

```shell
curl -i     \
     -X GET \
     http://username:password@localhost:17927/swaps
```

> The response body is structured like this:

```json
{
  "swaps": [
    {
      "id": "DiqkYPg/2mCzGhlk7ENighXhFDSkSYJ9+qmmVHI3UrE=",
      "sendToken": "BTC",
      "receiveToken": "ETH",
      "sendAmount": "20000",
      "receiveAmount": "2000000000000",
      "sendCost": {
        "BTC": "0"
      },
      "receiveCost": {
        "ETH": "0"
      },
      "timestamp": 1548656666,
      "timeLock": 1548678266,
      "status": 5,
      "delay": false,
      "active": true
    }
  ]
}
```

Check the status of existing swaps.

**HTTP Endpoint:** `GET /swaps`

|         | SwapperD | SwapperD Desktop |
| ------- | -------- | ---------------- |
| Mainnet | http://localhost:7927/swaps | http://localhost:7928/swaps |
| Testnet | http://localhost:17927/swaps | http://localhost:7928/swaps?network=testnet |

<aside class="success">
Basic Authentication is required for these SwapperD HTTP endpoints. 
</aside>
